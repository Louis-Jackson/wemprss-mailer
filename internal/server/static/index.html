<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wemprss-mailer 控制台</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    button { padding: 8px 12px; margin-right: 8px; }
    .row { margin: 12px 0; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 4px; overflow: auto; }
  </style>
  <script>
    async function call(path, opts={}) {
      const res = await fetch(path, Object.assign({ method: 'GET' }, opts));
      const text = await res.text();
      try { return { ok: res.ok, data: JSON.parse(text) }; } catch (e) { return { ok: res.ok, data: text }; }
    }
    async function refreshStatus() {
      const r = await call('/api/status');
      document.getElementById('status').textContent = JSON.stringify(r.data, null, 2);
    }
    async function health() {
      const r = await call('/api/health');
      alert('health: ' + (r.ok ? 'ok' : 'bad'));
    }
    async function sendNow() {
      const r = await call('/api/send-now', { method: 'POST' });
      alert('send-now: ' + (r.ok ? 'ok' : JSON.stringify(r.data)));
      refreshStatus();
    }
    async function triggerRefresh() {
      const r = await call('/api/refresh', { method: 'POST' });
      alert('refresh: ' + (r.ok ? 'ok' : JSON.stringify(r.data)));
    }
    async function ensure() {
      const r = await call('/api/ensure', { method: 'POST' });
      alert('ensure: ' + (r.ok ? 'ok' : JSON.stringify(r.data)));
    }
    window.addEventListener('load', refreshStatus);

    // === QR login helpers ===
    async function loadQr() {
      const img = document.getElementById('qrimg');
      const first = await call('/api/wx/auth/qr/code');
      document.getElementById('qrstatus').textContent = JSON.stringify(first.data, null, 2);
      try {
        let codePath = first.data?.data?.code || '';
        let isExists = first.data?.data?.is_exists;
        // 若服务器提示图片尚未生成，则短暂轮询等待
        if (isExists === false) {
          const deadline = Date.now() + 6000; // 最多等 6s
          while (Date.now() < deadline) {
            await new Promise(r => setTimeout(r, 800));
            const rr = await call('/api/wx/auth/qr/code');
            document.getElementById('qrstatus').textContent = JSON.stringify(rr.data, null, 2);
            codePath = rr.data?.data?.code || codePath;
            isExists = rr.data?.data?.is_exists;
            if (isExists === true) break;
          }
        }
        const base = '/api/wx/auth/qr/' + (codePath || '');
        const url = base + (base.includes('?') ? '&' : '?') + '_t=' + Date.now();
        img.src = url;
      } catch (e) {
        // fallback
        img.src = '';
      }
    }
    let polling = null;
    async function pollStatus() {
      if (polling) return;
      polling = setInterval(async () => {
        const r = await call('/api/wx/auth/qr/status');
        document.getElementById('qrstatus').textContent = JSON.stringify(r.data, null, 2);
      }, 2000);
    }
    async function finishScan() {
      const r = await call('/api/wx/auth/qr/over');
      document.getElementById('qrstatus').textContent = JSON.stringify(r.data, null, 2);
      if (polling) { clearInterval(polling); polling = null; }
    }
  </script>
</head>
<body>
  <h1>wemprss-mailer 控制台</h1>
  <div class="row">
    <button onclick="health()">健康检查</button>
    <button onclick="sendNow()">立即发送</button>
    <button onclick="triggerRefresh()">刷新数据</button>
    <button onclick="ensure()">确保最新（调用接口）</button>
  </div>
  <div class="row">
    <h3>扫码登录</h3>
    <div>
      <button onclick="loadQr()">获取二维码</button>
      <button onclick="pollStatus()">开始轮询状态</button>
      <button onclick="finishScan()">完成扫码</button>
    </div>
    <div class="row">
      <img id="qrimg" alt="二维码" style="width:240px;height:240px;border:1px solid #ddd;object-fit:contain" />
    </div>
    <pre id="qrstatus">未开始</pre>
  </div>
  <div class="row">
    <h3>状态</h3>
    <pre id="status">loading...</pre>
  </div>
</body>
</html>



